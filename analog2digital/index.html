<style>
body{
	background-color: #222;
	color: #DDD;
	font-family: Sans-serif;
}
#stdout{
	font-family: monospace;
	background-color: #000;
	color: #FFF;
	padding: 5px;
	position: fixed;
	right: 0;
	top: 0;
	z-index: 999;
}
#chart_div{
}
</style>
<script>
var g_limit=1.5;
function print(str){
	stdout.innerHTML=str;
}
var result_n=0;
function resultReset(){
	result_out.value='';
	result_n=0;
}
function result(str){
//	console.log(str);
	result_out.value=result_out.value+'\n'+result_n.toString(16)+"@"+str;
	result_n++;
}
function ReadFile(f,cb){
	var reader = new FileReader();
	reader.onload = function(a){
		try{
			eval("window.file="+a.target.result);
			print("File loaded");
			
			//displayInputGraph(window.file,1000,null);
			//displayGraph(window.file,100,2800,112000,frontDetector)
			
		}catch(e){
			print("Error l:"+e.lineNumber+" c:"+e.columnNumber+" : "+e.message);
		}
	}
	reader.readAsText(f);
}
function delta(array,at,size){return Math.abs(array[at]-(array[at-size]/2)-(array[at+size]/2));}
function frontDetector(array,at,size){return 100*((Math.abs(array[at]-(array[at-(size)]/2)-(array[at+(size)]/2)))>g_limit);}
var GraphOptions = {
	backgroundColor:"#222",
	hAxis: {textStyle:{color:"#DDD"},title: 'sample'},
	vAxis: {textStyle:{color:"#DDD"},viewWindow:{min:0x00,max:0xFF}}
};
function displayGraph(file,precision,from,to,extra,dump){
	var table=[['sample','chan:1','delta:1']];
	for(var i=from;i<to;i+=precision){
		table.push([i,file.Data[0][i],extra(file.Data[0],i,precision)]);
	}
	if(extra){
		getEdgeSpace(table,dump);
	}
	if(!dump)
		new google.visualization.AreaChart(document.getElementById('chart')).draw(google.visualization.arrayToDataTable(table), GraphOptions);
}
function displayInputGraph(file,precision,extra){
	var table=[['sample','chan:1']];
	if(extra)table[0].push('extra')
	for(var i=0;i<file.Data[0].length;i+=precision){
		if(extra)
			table.push([i,file.Data[0][i],extra(file.Data[0],i,precision)]);
		else
			table.push([i,file.Data[0][i]]);
	}
	new google.visualization.AreaChart(document.getElementById('overview')).draw(google.visualization.arrayToDataTable(table), GraphOptions);
}
function getEdgeSpace(table,dump){
	var prev_val=-1,prev_pos=table[1][2];
	for(var i=1;i<table.length;i++){
		if(prev_val==table[i][2])continue;
		if(prev_val>table[i][2])prev_pos=table[i][0];//save down front position
		if(prev_val<table[i][2]){//on upper front : compute value
			var avg=getAverage(prev_pos,table[i][0]);
			if(avg>0 && dump)
				dump(valueToData(avg,53,175,15));
		};
		prev_val=table[i][2];
	}
}
function getAverage(from,to){
	if(from==0)return 0;
	var avg=0;
	for(var i=from;i<to;i++){
		avg+=file.Data[0][i];
	}
	return (avg/(to-from));
}
function valueToData(val,min,max,size){
	return Math.round(((val-min)/(max-min))*size);
}
</script>
<output id="stdout"></output>
<h1>Input</h1>
<input type="file" onchange="ReadFile(event.target.files[0])"/>

<h1>Overview <button onclick="displayInputGraph(window.file,1000,null)">see</button></h1>
<div id="overview"></div>
<h1>Signal processing</h1>
<h3>Edge detect</h3>
<input id="g_limit" onchange="g_limit=1*this.value" value="1.5"/>
<h3>Viewbow</h3>
<input type="number" title="preci" id="prec"  value="100"/>
<input type="number" title="start" id="start" value="2800"/>
<input type="number" title="end"   id="end"   value="112000"/>

<h1>
	Result
	<button onclick="displayGraph(window.file,1*prec.value,1*start.value,1*end.value,frontDetector)">preview</button>
	<button onclick="resultReset();displayGraph(window.file,1*prec.value,0,file.Data[0].length,frontDetector,result)">dump</button>
</h1>
<div id="chart"></div>
<textarea id="result_out"></textarea>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script>
google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(function(){
	print("Graph library loaded");
});
g_limit=document.getElementById("g_limit").value;
</script>
