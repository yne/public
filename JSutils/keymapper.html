<html>
<head></head>
<body>
<textarea id="km" rows="12" cols="12" title="charmap" spellcheck="false">
AZERTYUIOP'
1234567890.
azertyuiop"

QSDFGHJKLM%
@é{([])}^&`
qsdfghjklm$*

>WXCVBN?./_
~#  |+-!=\^
<wxcvbn,;:

</textarea>
<textarea id="out" rows="12" cols="80" title="output" spellcheck="false"></textarea>
<script>
function getCharAtCoord(coord,alt){
	if(!coord)return;
	var lanes=km.value.split('\n');
	return lanes[coord[0]*2 + alt][coord[1]];
}
function getKeyCoord(event){
	var keymap=[
		[ 65, 90, 69, 82, 84, 89, 85, 73, 79, 80,168,163],//AZERTY
		[ 97,122,101,114,116,121,117,105,111,112, 94, 36],
		
		[ 81, 83, 68, 70, 71, 72, 74, 75, 76, 77, 37,181],//QSDF
		[113,115,100,102,103,104,106,107,108,109,249, 42],
		
		[ 62, 87, 88, 67, 86, 66, 78, 63, 46, 47,167],//>WXCV
		[ 60,119,120, 99,118, 98,110, 44, 59, 58, 33],
	];
	
	for(var lane in keymap)
		for(var key in keymap[lane])
			if(keymap[lane][key]==event.charCode)
				return [lane, key];
}

out.onkeypress=function(event){
	var alt=event.ctrlKey?1:0;
	var c=getCharAtCoord(getKeyCoord(event),alt);
	if(c==undefined||c==' '){
		console.log(event);
		if(event.keyCode==0){
			event.preventDefault();
			event.stopPropagation();
			return;
		}else{
			return;
		}
	}
	var pos=out.selectionStart;
	out.value = out.value.substr(0,pos) + c + out.value.substr(pos);
	out.selectionEnd=pos+1;
	out.selectionStart=pos+1;
	event.preventDefault();
}
</script>

</body>
</html>


