<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8"/>
<script>
	$=function(sel,base){return (base||document).querySelector(sel)};
	El=function(name,attr){var el=document.createElement(name);for(var i in attr)el.setAttribute(i,attr[i]);return el;}
</script>
	<script src="TitleMap.js"></script>
	<link rel="stylesheet" href="style.css"></style>
</head>
<body onload="P=new TitleMap()">
<button class="aside_open" onclick="$('aside').hidden=false;">File</button>

<aside _hidden><button class="close" onclick="$('aside').hidden=true;">&times;</button>
<form onsubmit="var e=this.elements;try{
	P.fromImage(+e.size.value,e.file.files[0]);
	}catch(e){console.error(e)};return false;">
	<legend><input type="submit" value="Load"/> from image dump</legend>
	<select name="size" title="Titles size"><option>8</option><option selected>16</option><option>32</option></select>
	<input name="file" type="file" accept="image/*" title="Image file" required/>
</form>
<form onsubmit="var e=this.elements;try{
	P.fromFiles(+e.s.value,e.map.files[0],e.ttl.files[0],e.sub.files[0]);
	}catch(e){console.error(e)};return false;">
	<legend><input type="submit" value="Load"/> from files [.map .ttl .sub]</legend>
	<select name="s" title="Titles size"><option>8</option><option selected>16</option><option>32</option></select>
	<input name="ttl" accept=".ttl" type="file" title="Title file" required/>
	<select name="map_u" title="MapDataType"><option value="8">u8</option><option value="16">u16</option></select>
	<input name="map" accept=".map" type="file" title="Map file" required/>
	<input name="sub" accept=".sub" type="file" title="Sub file (optional)"/>
</form>
<form onsubmit="var e=this.elements;try{
	P.toHref(e.do_sub.checked,$('[name=map]',this),$('[name=ttl]',this),$('[name=sub]',this));
	}catch(e){console.error(e)}return false;">
	<legend><input type="submit" value="Save"/> to files</legend>
	<a name="ttl">titles</a>
	<a name="att">attr</a>
	<a name="map">info</a>
	<input name="do_sub" type="checkbox"/><a name="sub">sub</a>
</form>
</aside>
<!--
GBC sample:http://i.imgur.com/B4d5t4j.png
GBC full  :http://i.imgur.com/b66Y95q.png
GBC fogRip:http://i.imgur.com/Hx7Fvim.png
LTP sample:http://i.imgur.com/SAzniqF.png
-->
<div class="map_container">
	<form style="margin:0;padding:0;" id="ta" onmousemove="mm(event.pageX,event.pageY)" onmouseup="mu()" onsubmit="console.log(this);this.hidden=true;return false;" hidden></form>
	<canvas id="view" onmousedown="md(event.pageX,event.pageY)" onmousemove="mm(event.pageX,event.pageY)" onmouseout="mm(event.pageX,event.pageY)" onmouseup="mu()"></canvas>
</div>

<script>
function md(x,y){
	if(ta.dataset.activ=='true')return;//mouse reenter
	ta.style.left=(x-x%P.size)+'px';
	ta.style.top=(y-y%P.size)+'px';
	ta.style.width=ta.style.height=0;
	ta.hidden=false;
	ta.innerHTML="";
	ta.dataset.activ=true;
	mm(x,y)
}
function mm(x,y){
	if(ta.dataset.activ!='true')return;
	ta.style.width =(((x+8)-(x+8)%P.size)-(ta.style.left.slice(0,-2)))+'px';
	ta.style.height=(((y+8)-(y+8)%P.size)-(ta.style.top .slice(0,-2)))+'px';
}
function mu(){
	if(ta.dataset.activ!='true')return;//already inactiv (form click?)
	ta.dataset.activ=false;
	[].slice.call(ta.children).forEach(function(ch){ta.removeChild(ch)});
	var offsetX=ta.style.left.slice(0,-2)/P.size;
	var offsetY=ta.style.top .slice(0,-2)/P.size;
	var width=P.view.width/P.size;
	//console.log(offsetX,offsetY,width)
	for(var y=0;y<ta.style.height.slice(0,-2)/P.size;y++)
		for(var x=0;x<ta.style.width.slice(0,-2)/P.size;x++){
			var input=document.createElement('input');
			input.style.width=input.style.height=P.size+'px';
			input.value=P.map[(y+offsetY)*width+((x+offsetX))];
			ta.appendChild(input)
		}
}
</script>

<div class="hud">
	<div class="conf">
		<input id="size" title="Titles size (px)" size="4" readonly />
		<input id="width" title="Map width (Title)" size="4" readonly />
	</div>
	<div class="titles_container"><span id="titles"/></div>
</div>

</body>
</html>